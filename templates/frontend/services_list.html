{% extends 'base.html' %}
{% block title %}–ü–æ—Å–ª—É–≥–∏ - VetBooking{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1>–ü–æ—Å–ª—É–≥–∏</h1>
        <p>–û–±–µ—Ä—ñ—Ç—å –ø–æ—Å–ª—É–≥—É —Ç–∞ –∑–∞–ø–∏—à—ñ—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–π–æ–º</p>
    </div>
</div>

<div class="container">
    <div class="filters-section">
        <div class="filter-group">
            <label>–¢–∏–ø –ø–æ—Å–ª—É–≥–∏:</label>
            <select id="service-type-filter">
                <option value="">–í—Å—ñ —Ç–∏–ø–∏</option>
                <option value="consultation">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è</option>
                <option value="vaccination">–í–∞–∫—Ü–∏–Ω–∞—Ü—ñ—è</option>
                <option value="surgery">–•—ñ—Ä—É—Ä–≥—ñ—è</option>
                <option value="dental">–°—Ç–æ–º–∞—Ç–æ–ª–æ–≥—ñ—è</option>
                <option value="grooming">–î–æ–≥–ª—è–¥</option>
                <option value="lab_test">–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ñ —Ç–µ—Å—Ç–∏</option>
                <option value="xray">–†–µ–Ω—Ç–≥–µ–Ω</option>
                <option value="ultrasound">–£–ó–î</option>
                <option value="therapy">–¢–µ—Ä–∞–ø—ñ—è</option>
                <option value="emergency">–ï–∫—Å—Ç—Ä–µ–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞</option>
            </select>
        </div>
        <div class="filter-group">
            <label>–ö–ª—ñ–Ω—ñ–∫–∞:</label>
            <select id="clinic-filter">
                <option value="">–í—Å—ñ –∫–ª—ñ–Ω—ñ–∫–∏</option>
            </select>
        </div>
        <div class="filter-group">
            <label>–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è:</label>
            <select id="sort-filter">
                <option value="price">–ó–∞ —Ü—ñ–Ω–æ—é</option>
                <option value="-price">–ó–∞ —Ü—ñ–Ω–æ—é (—Å–ø–∞–¥–∞–Ω–Ω—è)</option>
                <option value="name">–ó–∞ –Ω–∞–∑–≤–æ—é</option>
                <option value="duration_minutes">–ó–∞ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—é</option>
            </select>
        </div>
        <button onclick="applyFilters()" class="btn-primary">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
    </div>

    <div id="services-grid" class="cards-grid">
        <div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
    </div>
</div>

<script>
let services = [];
let clinics = [];

async function loadServices() {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const serviceType = urlParams.get('service_type') || '';
        const clinic = urlParams.get('clinic') || '';
        const ordering = urlParams.get('ordering') || 'service_type';

        let url = `/api/services/?ordering=${ordering}`;
        if (serviceType) url += `&service_type=${serviceType}`;
        if (clinic) url += `&clinic=${clinic}`;

        const response = await fetchAPI(url);
        const data = await response.json();
        services = data.results || data;

        displayServices();
        loadClinics();
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('services-grid').innerHTML =
            '<p class="error">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ—Å–ª—É–≥</p>';
    }
}

function displayServices() {
    const grid = document.getElementById('services-grid');

    if (services.length === 0) {
        grid.innerHTML = '<p class="no-results">–ü–æ—Å–ª—É–≥–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>';
        return;
    }

    grid.innerHTML = services.map(service => `
        <div class="card service-card">
            <div class="card-content">
                <h3>${service.name}</h3>
                <p class="service-type">${service.service_type_display}</p>
                <p class="description">${service.description}</p>
                <p class="clinic-name">üè• ${service.clinic_name}</p>
                <div class="service-footer">
                    <div>
                        <span class="price">${service.price} –≥—Ä–Ω</span>
                        <span class="duration">‚è± ${service.duration_minutes} —Ö–≤</span>
                    </div>
                    <button onclick="bookService(${service.id})" class="btn-primary">–ó–∞–ø–∏—Å–∞—Ç–∏—Å—è</button>
                </div>
            </div>
        </div>
    `).join('');
}

async function loadClinics() {
    try {
        const response = await fetchAPI('/api/clinics/');
        const data = await response.json();
        clinics = data.results || data;

        const select = document.getElementById('clinic-filter');
        const currentClinic = new URLSearchParams(window.location.search).get('clinic') || '';

        clinics.forEach(clinic => {
            const option = document.createElement('option');
            option.value = clinic.id;
            option.textContent = clinic.name;
            if (clinic.id == currentClinic) option.selected = true;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading clinics:', error);
    }
}

function applyFilters() {
    const serviceType = document.getElementById('service-type-filter').value;
    const clinic = document.getElementById('clinic-filter').value;
    const ordering = document.getElementById('sort-filter').value;

    const params = new URLSearchParams();
    if (serviceType) params.set('service_type', serviceType);
    if (clinic) params.set('clinic', clinic);
    if (ordering) params.set('ordering', ordering);

    window.location.href = `/services/?${params.toString()}`;
}

function bookService(serviceId) {
    const token = localStorage.getItem('access_token');
    if (!token) {
        alert('–ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è –∑–∞–ø–∏—Å—É –Ω–∞ –ø—Ä–∏–π–æ–º');
        window.location.href = '/login/';
        return;
    }
    window.location.href = `/appointments/create/?service=${serviceId}`;
}

loadServices();


const urlParams = new URLSearchParams(window.location.search);
document.getElementById('service-type-filter').value = urlParams.get('service_type') || '';
document.getElementById('sort-filter').value = urlParams.get('ordering') || 'service_type';
</script>
{% endblock %}