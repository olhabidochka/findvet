{% extends 'base.html' %}
{% block title %}–ù–æ–≤–∏–π –∑–∞–ø–∏—Å - VetBooking{% endblock %}
{% block content %}
<div class="container">
    <h1>–ó–∞–ø–∏—Å –Ω–∞ –ø—Ä–∏–π–æ–º</h1>
    <form id="appointment-form" class="form">
        <div class="form-group">
            <label>–õ—ñ–∫–∞—Ä: <span style="color: red;">*</span></label>
            <select id="doctor" required>
                <option value="">–û–±–µ—Ä—ñ—Ç—å –ª—ñ–∫–∞—Ä—è...</option>
            </select>
            <small>–û–±–µ—Ä—ñ—Ç—å –ª—ñ–∫–∞—Ä—è –¥–ª—è –∑–∞–ø–∏—Å—É –Ω–∞ –ø—Ä–∏–π–æ–º</small>
        </div>

        <div class="form-group">
            <label>–ü–æ—Å–ª—É–≥–∞: <span style="color: red;">*</span></label>
            <select id="service" required>
                <option value="">–û–±–µ—Ä—ñ—Ç—å –ø–æ—Å–ª—É–≥—É...</option>
            </select>
            <small>–¢–∏–ø –ø–æ—Å–ª—É–≥–∏ —Ç–∞ —ó—ó –≤–∞—Ä—Ç—ñ—Å—Ç—å</small>
        </div>

        <div class="form-group">
            <label>–î–∞—Ç–∞: <span style="color: red;">*</span></label>
            <input type="date" id="date" required>
            <small>–û–±–µ—Ä—ñ—Ç—å –∑—Ä—É—á–Ω—É –¥–∞—Ç—É –¥–ª—è –≤—ñ–∑–∏—Ç—É</small>
        </div>

        <div class="form-group">
            <label>–ß–∞—Å: <span style="color: red;">*</span></label>
            <input type="time" id="time" required>
            <small>–û–±–µ—Ä—ñ—Ç—å –∑—Ä—É—á–Ω–∏–π —á–∞—Å</small>
        </div>

        <div class="form-group">
            <label>–ü—Ä–∏–º—ñ—Ç–∫–∏:</label>
            <textarea id="notes" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Å—Ç–∞–Ω —Ç–≤–∞—Ä–∏–Ω–∏, –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ..."></textarea>
            <small>–ù–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ: –¥–æ–¥–∞–π—Ç–µ –±—É–¥—å-—è–∫—É –≤–∞–∂–ª–∏–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é</small>
        </div>

        <div style="background: #e3f2fd; padding: 1rem; border-radius: 6px; margin: 1rem 0;">
            <h4 style="margin-bottom: 0.5rem;">üìã –ü—ñ–¥—Å—É–º–æ–∫ –∑–∞–ø–∏—Å—É:</h4>
            <p id="summary-doctor" style="margin: 0.25rem 0;">–õ—ñ–∫–∞—Ä: <em>–Ω–µ –æ–±—Ä–∞–Ω–æ</em></p>
            <p id="summary-service" style="margin: 0.25rem 0;">–ü–æ—Å–ª—É–≥–∞: <em>–Ω–µ –æ–±—Ä–∞–Ω–æ</em></p>
            <p id="summary-date" style="margin: 0.25rem 0;">–î–∞—Ç–∞ —Ç–∞ —á–∞—Å: <em>–Ω–µ –æ–±—Ä–∞–Ω–æ</em></p>
        </div>

        <button type="submit" class="btn-primary" style="width: 100%;">‚úì –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–ø–∏—Å</button>
    </form>
    <div id="message" class="error" style="display: none;"></div>
</div>

<script>
const token = localStorage.getItem('access_token');
if (!token) {
    window.location.href = '/login/';
}

let doctors = [];
let services = [];

async function loadDoctors() {
    try {
        const response = await fetchAPI('/api/doctors/');
        const data = await response.json();
        doctors = data.results || data;

        const doctorSelect = document.getElementById('doctor');
        doctorSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –ª—ñ–∫–∞—Ä—è...</option>' +
            doctors.map(d =>
                `<option value="${d.id}">${d.full_name} - ${d.specialization_display} (${d.clinic_name})</option>`
            ).join('');

        const urlParams = new URLSearchParams(window.location.search);
        const doctorId = urlParams.get('doctor');
        if (doctorId) {
            doctorSelect.value = doctorId;
            updateSummary();
        }

        loadServices();
    } catch (error) {
        console.error('Error loading doctors:', error);
    }
}

async function loadServices() {
    try {
        const response = await fetchAPI('/api/services/');
        const data = await response.json();
        services = data.results || data;

        const serviceSelect = document.getElementById('service');
        serviceSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –ø–æ—Å–ª—É–≥—É...</option>' +
            services.map(s =>
                `<option value="${s.id}">${s.name} - ${s.price} –≥—Ä–Ω (${s.duration_minutes} —Ö–≤) - ${s.clinic_name}</option>`
            ).join('');

        const urlParams = new URLSearchParams(window.location.search);
        const serviceId = urlParams.get('service');
        if (serviceId) {
            serviceSelect.value = serviceId;
            updateSummary();
        }
    } catch (error) {
        console.error('Error loading services:', error);
    }
}

document.getElementById('doctor').addEventListener('change', updateSummary);
document.getElementById('service').addEventListener('change', updateSummary);
document.getElementById('date').addEventListener('change', updateSummary);
document.getElementById('time').addEventListener('change', updateSummary);

function updateSummary() {
    const doctorId = document.getElementById('doctor').value;
    const serviceId = document.getElementById('service').value;
    const date = document.getElementById('date').value;
    const time = document.getElementById('time').value;

    const doctor = doctors.find(d => d.id == doctorId);
    const service = services.find(s => s.id == serviceId);

    document.getElementById('summary-doctor').innerHTML = doctor
        ? `–õ—ñ–∫–∞—Ä: <strong>${doctor.full_name}</strong> (${doctor.specialization_display})`
        : '–õ—ñ–∫–∞—Ä: <em>–Ω–µ –æ–±—Ä–∞–Ω–æ</em>';

    document.getElementById('summary-service').innerHTML = service
        ? `–ü–æ—Å–ª—É–≥–∞: <strong>${service.name}</strong> - ${service.price} –≥—Ä–Ω`
        : '–ü–æ—Å–ª—É–≥–∞: <em>–Ω–µ –æ–±—Ä–∞–Ω–æ</em>';

    document.getElementById('summary-date').innerHTML = date && time
        ? `–î–∞—Ç–∞ —Ç–∞ —á–∞—Å: <strong>${new Date(date).toLocaleDateString('uk-UA')} –æ ${time}</strong>`
        : '–î–∞—Ç–∞ —Ç–∞ —á–∞—Å: <em>–Ω–µ –æ–±—Ä–∞–Ω–æ</em>';
}

const today = new Date().toISOString().split('T')[0];
document.getElementById('date').setAttribute('min', today);

document.getElementById('appointment-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const messageDiv = document.getElementById('message');
    messageDiv.style.display = 'none';
    messageDiv.textContent = '';

    const data = {
        doctor: document.getElementById('doctor').value,
        service: document.getElementById('service').value,
        appointment_date: document.getElementById('date').value,
        appointment_time: document.getElementById('time').value,
        notes: document.getElementById('notes').value,
    };

    try {
        const response = await fetchAPI('/api/appointments/', {
            method: 'POST',
            body: JSON.stringify(data)
        });

        if (response.ok) {
            alert('‚úì –ó–∞–ø–∏—Å —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ! –û—á—ñ–∫—É–π—Ç–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è.');
            window.location.href = '/appointments/';
        } else {
            const error = await response.json();
            messageDiv.style.display = 'block';
            messageDiv.textContent = error.detail || error.non_field_errors?.[0] || '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –∑–∞–ø–∏—Å—É';
        }
    } catch (error) {
        messageDiv.style.display = 'block';
        messageDiv.textContent = '–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞';
    }
});

loadDoctors();
</script>
{% endblock %}