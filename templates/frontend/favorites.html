{% extends 'base.html' %}

{% block title %}–û–±—Ä–∞–Ω—ñ –ª—ñ–∫–∞—Ä—ñ - VetBooking{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1>–û–±—Ä–∞–Ω—ñ –ª—ñ–∫–∞—Ä—ñ</h1>
        <p>–í–∞—à—ñ —É–ª—é–±–ª–µ–Ω—ñ –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä–∏</p>
    </div>
</div>

<div class="container">
    <div id="favorites-grid" class="cards-grid">
        <div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
    </div>
</div>

<script>
async function loadFavorites() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/login/';
        return;
    }

    try {
        const response = await fetchAPI('/api/favorites/');
        if (!response.ok) {
            throw new Error('Failed to load favorites');
        }

        const data = await response.json();
        const favorites = data.results || data;

        const grid = document.getElementById('favorites-grid');

        if (favorites.length === 0) {
            grid.innerHTML = `
                <div class="no-results">
                    <p>–£ –≤–∞—Å –ø–æ–∫–∏ –Ω–µ–º–∞—î –æ–±—Ä–∞–Ω–∏—Ö –ª—ñ–∫–∞—Ä—ñ–≤</p>
                    <a href="/doctors/" class="btn-primary">–ó–Ω–∞–π—Ç–∏ –ª—ñ–∫–∞—Ä—ñ–≤</a>
                </div>
            `;
            return;
        }

        grid.innerHTML = favorites.map(fav => {
            const doctor = fav.doctor;
            return `
                <div class="card doctor-card">
                    <img src="${doctor.photo || '/static/images/doctor-placeholder.jpg'}"
                         alt="${doctor.full_name}">
                    <div class="card-content">
                        <h3>${doctor.full_name}</h3>
                        <p class="specialization">${doctor.specialization_display}</p>
                        <p class="clinic">üè• ${doctor.clinic_name}</p>
                        <p class="experience">–î–æ—Å–≤—ñ–¥: ${doctor.experience_years} —Ä–æ–∫—ñ–≤</p>
                        <div class="rating">‚≠ê ${doctor.rating}/5</div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <a href="/doctors/${doctor.id}/" class="btn-primary" style="flex: 1; text-align: center;">–î–µ—Ç–∞–ª—å–Ω—ñ—à–µ</a>
                            <button onclick="removeFromFavorites(${doctor.id})" class="btn-danger">‚ù§Ô∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    } catch (error) {
        console.error('Error loading favorites:', error);
        document.getElementById('favorites-grid').innerHTML = `
            <p class="error">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –æ–±—Ä–∞–Ω–∏—Ö –ª—ñ–∫–∞—Ä—ñ–≤</p>
        `;
    }
}

async function removeFromFavorites(doctorId) {
    if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –ª—ñ–∫–∞—Ä—è –∑ –æ–±—Ä–∞–Ω–∏—Ö?')) {
        return;
    }

    try {
        const response = await fetchAPI(`/api/doctors/${doctorId}/remove_from_favorites/`, {
            method: 'POST'
        });

        if (response.ok) {
            alert('–í–∏–¥–∞–ª–µ–Ω–æ –∑ –æ–±—Ä–∞–Ω–∏—Ö');
            loadFavorites();
        } else {
            alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ');
        }
    } catch (error) {
        alert('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è');
    }
}

loadFavorites();
</script>
{% endblock %}