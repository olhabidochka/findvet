{% extends 'base.html' %}

{% block title %}–õ—ñ–∫–∞—Ä—ñ - VetBooking{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1>–ù–∞—à—ñ –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä–∏</h1>
        <p>–ó–Ω–∞–π–¥—ñ—Ç—å –¥–æ—Å–≤—ñ–¥—á–µ–Ω–æ–≥–æ —Å–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç–∞ –¥–ª—è –≤–∞—à–æ–≥–æ —É–ª—é–±–ª–µ–Ω—Ü—è</p>
    </div>
</div>

<div class="container">
    <div class="filters-section">
        <div class="filter-group">
            <label>–°–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è:</label>
            <select id="specialization-filter">
                <option value="">–í—Å—ñ —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó</option>
                <option value="general">–ó–∞–≥–∞–ª—å–Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞</option>
                <option value="surgeon">–•—ñ—Ä—É—Ä–≥</option>
                <option value="dentist">–°—Ç–æ–º–∞—Ç–æ–ª–æ–≥</option>
                <option value="dermatologist">–î–µ—Ä–º–∞—Ç–æ–ª–æ–≥</option>
                <option value="cardiologist">–ö–∞—Ä–¥—ñ–æ–ª–æ–≥</option>
                <option value="ophthalmologist">–û—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥</option>
                <option value="orthopedist">–û—Ä—Ç–æ–ø–µ–¥</option>
                <option value="neurologist">–ù–µ–≤—Ä–æ–ª–æ–≥</option>
            </select>
        </div>
        <div class="filter-group">
            <label>–ö–ª—ñ–Ω—ñ–∫–∞:</label>
            <select id="clinic-filter">
                <option value="">–í—Å—ñ –∫–ª—ñ–Ω—ñ–∫–∏</option>
            </select>
        </div>
        <div class="filter-group">
            <label>–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è:</label>
            <select id="sort-filter">
                <option value="-rating">–ó–∞ —Ä–µ–π—Ç–∏–Ω–≥–æ–º</option>
                <option value="last_name">–ó–∞ –ø—Ä—ñ–∑–≤–∏—â–µ–º</option>
                <option value="-experience_years">–ó–∞ –¥–æ—Å–≤—ñ–¥–æ–º</option>
            </select>
        </div>
        <button onclick="applyFilters()" class="btn-primary">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
        <button onclick="resetFilters()" class="btn-secondary">–°–∫–∏–Ω—É—Ç–∏</button>
    </div>

    <div id="doctors-grid" class="cards-grid">
        <div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
    </div>
</div>

<script>
    let doctors = [];
    let clinics = [];

    async function loadDoctors() {
        const grid = document.getElementById('doctors-grid');

        try {
            const urlParams = new URLSearchParams(window.location.search);
            const specialization = urlParams.get('specialization') || '';
            const clinic = urlParams.get('clinic') || '';
            const ordering = urlParams.get('ordering') || '-rating';

            let url = `/api/doctors/?ordering=${ordering}`;
            if (specialization) url += `&specialization=${specialization}`;
            if (clinic) url += `&clinic=${clinic}`;

            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to load doctors');

            const data = await response.json();
            doctors = data.results || data;

            displayDoctors();
            loadClinics();
        } catch (error) {
            console.error('Error:', error);
            grid.innerHTML = '<p class="error">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ª—ñ–∫–∞—Ä—ñ–≤</p>';
        }
    }

    function displayDoctors() {
        const grid = document.getElementById('doctors-grid');

        if (!doctors || doctors.length === 0) {
            grid.innerHTML = '<p class="no-results">–õ—ñ–∫–∞—Ä—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>';
            return;
        }

        grid.innerHTML = doctors.map(doctor => `
            <div class="card doctor-card">
                ${doctor.photo ?
                    `<img src="${doctor.photo}" alt="${doctor.full_name}">` :
                    `<div style="height: 200px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem;">üë®‚Äç‚öïÔ∏è</div>`
                }
                <div class="card-content">
                    <h3>${doctor.full_name}</h3>
                    <p class="specialization">${doctor.specialization_display}</p>
                    <p class="clinic">üè• ${doctor.clinic_name}</p>
                    <p class="experience">üìö –î–æ—Å–≤—ñ–¥: ${doctor.experience_years} —Ä–æ–∫—ñ–≤</p>
                    <div class="rating">‚≠ê ${doctor.rating}/5</div>
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <a href="/doctors/${doctor.id}/" class="btn-secondary" style="flex: 1; text-align: center;">–î–µ—Ç–∞–ª—å–Ω—ñ—à–µ</a>
                        <a href="/appointments/create/?doctor=${doctor.id}" class="btn-primary" style="flex: 1; text-align: center;">–ó–∞–ø–∏—Å–∞—Ç–∏—Å—è</a>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async function loadClinics() {
        try {
            const response = await fetch('/api/clinics/');
            const data = await response.json();
            clinics = data.results || data;

            const select = document.getElementById('clinic-filter');
            const currentClinic = new URLSearchParams(window.location.search).get('clinic') || '';

            clinics.forEach(clinic => {
                const option = document.createElement('option');
                option.value = clinic.id;
                option.textContent = clinic.name;
                if (clinic.id == currentClinic) option.selected = true;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading clinics:', error);
        }
    }

    function applyFilters() {
        const specialization = document.getElementById('specialization-filter').value;
        const clinic = document.getElementById('clinic-filter').value;
        const ordering = document.getElementById('sort-filter').value;

        const params = new URLSearchParams();
        if (specialization) params.set('specialization', specialization);
        if (clinic) params.set('clinic', clinic);
        if (ordering) params.set('ordering', ordering);

        window.location.href = `/doctors/?${params.toString()}`;
    }

    function resetFilters() {
        window.location.href = '/doctors/';
    }

    loadDoctors();

    // Set current filter values
    const urlParams = new URLSearchParams(window.location.search);
    document.getElementById('specialization-filter').value = urlParams.get('specialization') || '';
    document.getElementById('sort-filter').value = urlParams.get('ordering') || '-rating';
</script>
{% endblock %}