{% extends 'base.html' %}

{% block title %}–ö–ª—ñ–Ω—ñ–∫–∏ - VetBooking{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1>–í–µ—Ç–µ—Ä–∏–Ω–∞—Ä–Ω—ñ –∫–ª—ñ–Ω—ñ–∫–∏</h1>
        <p>–û–±–µ—Ä—ñ—Ç—å –Ω–∞–π–∫—Ä–∞—â—É –∫–ª—ñ–Ω—ñ–∫—É –¥–ª—è –≤–∞—à–æ–≥–æ —É–ª—é–±–ª–µ–Ω—Ü—è</p>
    </div>
</div>

<div class="container">
    <div class="filters-section">
        <div class="filter-group">
            <label>–ü–æ—à—É–∫:</label>
            <input type="text" id="search" placeholder="–ù–∞–∑–≤–∞, –º—ñ—Å—Ç–æ...">
        </div>
        <div class="filter-group">
            <label>–ú—ñ—Å—Ç–æ:</label>
            <select id="city-filter">
                <option value="">–í—Å—ñ –º—ñ—Å—Ç–∞</option>
            </select>
        </div>
        <div class="filter-group">
            <label>–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è:</label>
            <select id="sort-filter">
                <option value="-rating">–ó–∞ —Ä–µ–π—Ç–∏–Ω–≥–æ–º</option>
                <option value="name">–ó–∞ –Ω–∞–∑–≤–æ—é</option>
            </select>
        </div>
        <button onclick="applyFilters()" class="btn-primary">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
    </div>

    <div id="clinics-grid" class="cards-grid">
        <div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
    </div>
</div>

<script>
    let clinics = [];

    async function loadClinics() {
        const grid = document.getElementById('clinics-grid');

        try {
            const urlParams = new URLSearchParams(window.location.search);
            const search = urlParams.get('search') || '';
            const city = urlParams.get('city') || '';
            const ordering = urlParams.get('ordering') || '-rating';

            let url = `/api/clinics/?ordering=${ordering}`;
            if (search) url += `&search=${search}`;
            if (city) url += `&city=${city}`;

            console.log('Fetching clinics from:', url);

            const response = await fetch(url);
            console.log('Response status:', response.status);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Clinics data:', data);

            clinics = data.results || data;

            displayClinics();
            populateCityFilter();
        } catch (error) {
            console.error('Error loading clinics:', error);
            grid.innerHTML = '<p class="error">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–ª—ñ–Ω—ñ–∫. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.</p>';
        }
    }

    function displayClinics() {
        const grid = document.getElementById('clinics-grid');

        if (!clinics || clinics.length === 0) {
            grid.innerHTML = '<p class="no-results">–ö–ª—ñ–Ω—ñ–∫–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>';
            return;
        }

        grid.innerHTML = clinics.map(clinic => `
            <div class="card clinic-card">
                ${clinic.image ?
                    `<img src="${clinic.image}" alt="${clinic.name}">` :
                    `<div style="height: 200px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem;">üè•</div>`
                }
                <div class="card-content">
                    <h3>${clinic.name}</h3>
                    <p class="clinic-address">üìç ${clinic.address}, ${clinic.city}</p>
                    <p class="clinic-phone">üìû ${clinic.phone}</p>
                    <div class="clinic-specializations">
                        ${(clinic.specializations || []).map(s =>
                            `<span class="badge">${s.specialization_display}</span>`
                        ).join('')}
                    </div>
                    <div class="clinic-footer">
                        <div class="rating">‚≠ê ${clinic.rating}/5</div>
                        <a href="/clinics/${clinic.id}/" class="btn-primary">–î–µ—Ç–∞–ª—å–Ω—ñ—à–µ</a>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function populateCityFilter() {
        const cities = [...new Set(clinics.map(c => c.city))];
        const select = document.getElementById('city-filter');
        const currentCity = new URLSearchParams(window.location.search).get('city') || '';

        cities.forEach(city => {
            const option = document.createElement('option');
            option.value = city;
            option.textContent = city;
            if (city === currentCity) option.selected = true;
            select.appendChild(option);
        });
    }

    function applyFilters() {
        const search = document.getElementById('search').value;
        const city = document.getElementById('city-filter').value;
        const ordering = document.getElementById('sort-filter').value;

        const params = new URLSearchParams();
        if (search) params.set('search', search);
        if (city) params.set('city', city);
        if (ordering) params.set('ordering', ordering);

        window.location.href = `/clinics/?${params.toString()}`;
    }


    loadClinics();


    const urlParams = new URLSearchParams(window.location.search);
    document.getElementById('search').value = urlParams.get('search') || '';
    document.getElementById('sort-filter').value = urlParams.get('ordering') || '-rating';
</script>
{% endblock %}